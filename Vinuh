<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>VinuHub - Staking Platform</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: linear-gradient(135deg, #1a1a1a, #000);
            color: #fff;
            font-family: 'Poppins', sans-serif;
            min-height: 100vh;
            overflow-x: hidden;
        }
        header {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(8px);
            padding: 20px;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 100;
            box-shadow: 0 2px 10px rgba(255, 255, 255, 0.05);
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .logo {
            width: 160px;
            filter: grayscale(100%) drop-shadow(0 0 5px rgba(255, 255, 255, 0.2));
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        .logo:hover { transform: scale(1.03); }
        h1 {
            font-size: 2.2rem;
            font-weight: 600;
            letter-spacing: 2px;
            text-transform: uppercase;
            margin: 10px 0;
            color: #ddd;
        }
        section {
            padding: 30px 15px;
            max-width: 1000px;
            margin: auto;
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        h2 {
            font-size: 1.6rem;
            font-weight: 400;
            letter-spacing: 1px;
            text-align: center;
            color: #ccc;
            margin-bottom: 15px;
        }
        .card {
            background: rgba(50, 50, 50, 0.3);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.1);
            animation: fadeScale 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        @keyframes fadeScale {
            from { opacity: 0; transform: scale(0.98); }
            to { opacity: 1; transform: scale(1); }
        }
        .card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(255, 255, 255, 0.15);
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1), box-shadow 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input, button {
            background: rgba(60, 60, 60, 0.5);
            color: #fff;
            border: 1px solid rgba(255, 255, 255, 0.2);
            padding: 12px;
            border-radius: 6px;
            margin: 10px 0;
            width: 100%;
            font-family: 'Poppins', sans-serif;
            font-size: 0.95rem;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        input:focus {
            outline: none;
            border-color: #ccc;
            background: rgba(80, 80, 80, 0.7);
        }
        button {
            background: linear-gradient(45deg, #ccc, #fff);
            color: #000;
            font-weight: 400;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }
        button:hover {
            background: linear-gradient(45deg, #bbb, #eee);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 255, 255, 0.2);
        }
        button:disabled {
            background: #444;
            color: #777;
            cursor: not-allowed;
        }
        button::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            background: radial-gradient(circle, rgba(255, 255, 255, 0.3), transparent);
            transform: translate(-50%, -50%);
            transition: width 0.4s cubic-bezier(0.4, 0, 0.2, 1), height 0.4s cubic-bezier(0.4, 0, 0.2, 1), opacity 0.4s;
        }
        button:hover::after {
            width: 150px;
            height: 150px;
            opacity: 0;
        }
        #disconnectWallet {
            background: linear-gradient(#ff6666, #cc3333);
        }
        #disconnectWallet:hover {
            background: linear-gradient(#cc3333, #992222);
        }
        .dashboard, .leaderboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }
        .dashboard .card, .leaderboard .card {
            text-align: center;
            padding: 25px;
        }
        .dashboard h3, .leaderboard h3 {
            font-size: 1.1rem;
            color: #bbb;
            margin-bottom: 8px;
        }
        .dashboard p, .leaderboard p {
            font-size: 1.4rem;
            font-weight: 400;
            color: #ddd;
        }
        .leaderboard .card {
            animation-delay: 0.2s;
        }
        .leaderboard p {
            font-size: 1rem;
            word-break: break-all;
        }
        .error {
            color: #f88;
            font-size: 0.85rem;
            text-align: center;
            margin-top: 8px;
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #wallet-address {
            font-size: 0.85rem;
            color: #aaa;
            margin-top: 8px;
            word-break: break-all;
            animation: fadeIn 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #status {
            text-align: center;
            padding: 12px;
            background: #444444;
            border-radius: 6px;
            border-left: 4px solid #ffffff;
            margin-top: 15px;
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0.5); }
            70% { box-shadow: 0 0 0 8px rgba(255, 255, 255, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 255, 255, 0); }
        }
        .spinner {
            display: none;
            border: 4px solid #ffffff;
            border-top: 4px solid #000000;
            border-radius: 50%;
            width: 24px;
            height: 24px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        footer {
            background: rgba(20, 20, 20, 0.9);
            backdrop-filter: blur(8px);
            padding: 12px;
            text-align: center;
            font-size: 0.85rem;
            color: #aaa;
            animation: fadeIn 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        footer a {
            color: #ccc;
            text-decoration: none;
            transition: color 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        footer a:hover {
            color: #fff;
        }
        @media (max-width: 768px) {
            h1 { font-size: 1.8rem; }
            h2 { font-size: 1.3rem; }
            section { padding: 15px; }
            .card { padding: 15px; }
            .dashboard, .leaderboard { grid-template-columns: 1fr; }
            button:hover { transform: translateY(-1px); }
            button::after { width: 100px; height: 100px; }
        }
    </style>
</head>
<body>
    <header>
        <img src="https://photos.pinksale.finance/file/pinksale-logo-upload/1759847695513-f915ce15471ce09f03d8fbf68bc0616f.png" alt="VinuHub Logo" class="logo">
        <h1>VinuHub Staking</h1>
        <button id="connectWallet">Connect Wallet</button>
        <button id="disconnectWallet" style="display: none;">Disconnect Wallet</button>
        <p id="wallet-address"></p>
        <div id="status"></div>
        <div class="spinner" id="spinner"></div>
    </header>

    <section id="staking">
        <h2>Stake Your VIN</h2>
        <div class="card">
            <p>Minimum Stake: 10 VIN</p>
            <p>Minimum Lock: 7 Days</p>
            <p>APY: ~15% (variable)</p>
            <input type="number" id="stake-amount" placeholder="Enter amount (min 10 VIN)" min="10">
            <button id="approve-btn" disabled>Approve VIN<span class="spinner" style="display: none;"></span></button>
            <button id="stake-btn" disabled>Stake Now<span class="spinner" style="display: none;"></span></button>
            <p id="stake-error" class="error"></p>
        </div>
    </section>

    <section id="dashboard">
        <h2>Your Dashboard</h2>
        <div class="dashboard">
            <div class="card">
                <h3>Staked Amount</h3>
                <p id="staked-amount">0 VIN</p>
            </div>
            <div class="card">
                <h3>Lock Time Left</h3>
                <p id="lock-time">0 Days</p>
            </div>
            <div class="card">
                <h3>Accrued Rewards</h3>
                <p id="rewards">0 VIN</p>
                <button id="unstake-btn" disabled>Unstake<span class="spinner" style="display: none;"></span></button>
                <button id="emergency-unstake-btn" disabled>Emergency Unstake (10% Fee)<span class="spinner" style="display: none;"></span></button>
            </div>
        </div>
        <p id="dashboard-error" class="error"></p>
    </section>

    <section id="leaderboard">
        <h2>Top Stakers</h2>
        <div class="leaderboard" id="leaderboard-content">
            <!-- Dynamically populated -->
        </div>
        <p id="leaderboard-error" class="error"></p>
    </section>

    <footer>
        &copy; 2025 VinuHub. Built on VinuChain. <a href="https://t.me/Vinuhub" target="_blank">Join our Telegram</a>
    </footer>

    <script>
        // Load ethers.js with fallback
        function loadScript(src, callback) {
            const script = document.createElement('script');
            script.src = src;
            script.async = true;
            script.onload = () => callback(null);
            script.onerror = () => callback(new Error(`Failed to load script: ${src}`));
            document.head.appendChild(script);
        }

        const cdnUrls = [
            'https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js',
            'https://cdn.jsdelivr.net/npm/ethers@5.7.2/dist/ethers.umd.min.js'
        ];

        let ethersLoaded = false;
        let currentCdnIndex = 0;

        function tryLoadEthers() {
            if (currentCdnIndex >= cdnUrls.length) {
                document.getElementById('status').textContent = 'Error: Failed to load ethers.js from all sources. Check your internet or try again later.';
                console.error('All ethers.js CDNs failed');
                return;
            }
            loadScript(cdnUrls[currentCdnIndex], (error) => {
                if (error) {
                    console.error(error);
                    currentCdnIndex++;
                    tryLoadEthers();
                } else if (typeof ethers !== 'undefined') {
                    ethersLoaded = true;
                    initializeWallet();
                } else {
                    currentCdnIndex++;
                    tryLoadEthers();
                }
            });
        }

        // Contract details
        const contractAddress = '0x3d0Be68690c09264Bd249927e7638F504eC46B6b';
        const vinTokenAddress = '0x6109835364EdA2c43CaA8981681e75782C13566C';
        const contractABI = [
            {"inputs":[{"internalType":"address","name":"_vinToken","type":"address"}],"stateMutability":"nonpayable","type":"constructor"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"}],"name":"Staked","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"rewards","type":"uint256"}],"name":"Unstaked","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"user","type":"address"},{"indexed":false,"internalType":"uint256","name":"amount","type":"uint256"},{"indexed":false,"internalType":"uint256","name":"penalty","type":"uint256"}],"name":"EmergencyUnstaked","type":"event"},
            {"anonymous":false,"inputs":[{"indexed":true,"internalType":"address","name":"previousOwner","type":"address"},{"indexed":true,"internalType":"address","name":"newOwner","type":"address"}],"name":"OwnershipTransferred","type":"event"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"calculateRewards","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"emergencyUnstake","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"_user","type":"address"}],"name":"getStakeInfo","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"lockTimeLeft","type":"uint256"},{"internalType":"uint256","name":"rewards","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"getLeaderboard","outputs":[{"internalType":"address[]","name":"users","type":"address[]"},{"internalType":"uint256[]","name":"amounts","type":"uint256[]"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minLockPeriod","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"minStake","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"owner","outputs":[{"internalType":"address","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"renounceOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"_amount","type":"uint256"}],"name":"stake","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"","type":"address"}],"name":"stakes","outputs":[{"internalType":"uint256","name":"amount","type":"uint256"},{"internalType":"uint256","name":"timestamp","type":"uint256"},{"internalType":"uint256","name":"rewards","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"address","name":"newOwner","type":"address"}],"name":"transferOwnership","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"unstake","outputs":[],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[],"name":"vinToken","outputs":[{"internalType":"contract IERC20","name":"","type":"address"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"rewardRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"penaltyRate","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[],"name":"MAX_LEADERBOARD_SIZE","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"},
            {"inputs":[{"internalType":"uint256","name":"","type":"uint256"}],"name":"leaderboard","outputs":[{"internalType":"address","name":"user","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];
        const tokenABI = [
            {"inputs":[{"internalType":"address","name":"spender","type":"address"},{"internalType":"uint256","name":"amount","type":"uint256"}],"name":"approve","outputs":[{"internalType":"bool","name":"","type":"bool"}],"stateMutability":"nonpayable","type":"function"},
            {"inputs":[{"internalType":"address","name":"account","type":"address"}],"name":"balanceOf","outputs":[{"internalType":"uint256","name":"","type":"uint256"}],"stateMutability":"view","type":"function"}
        ];

        let provider, signer, contract, tokenContract, userAddress;

        // DOM elements
        const connectBtn = document.getElementById('connectWallet');
        const disconnectBtn = document.getElementById('disconnectWallet');
        const walletAddressEl = document.getElementById('wallet-address');
        const statusEl = document.getElementById('status');
        const spinnerEl = document.getElementById('spinner');
        const stakeAmountInput = document.getElementById('stake-amount');
        const approveBtn = document.getElementById('approve-btn');
        const stakeBtn = document.getElementById('stake-btn');
        const unstakeBtn = document.getElementById('unstake-btn');
        const emergencyUnstakeBtn = document.getElementById('emergency-unstake-btn');
        const stakeErrorEl = document.getElementById('stake-error');
        const dashboardErrorEl = document.getElementById('dashboard-error');
        const leaderboardErrorEl = document.getElementById('leaderboard-error');
        const stakedAmountEl = document.getElementById('staked-amount');
        const lockTimeEl = document.getElementById('lock-time');
        const rewardsEl = document.getElementById('rewards');
        const leaderboardContent = document.getElementById('leaderboard-content');

        // VinuChain config (exact match to Sender)
        const vinuChain = {
            chainId: '0xCF',
            chainName: 'VinuChain',
            rpcUrls: ['https://rpc.vinuchain.org', 'https://vinuchain-rpc.com'],
            nativeCurrency: { name: 'VC', symbol: 'VC', decimals: 18 },
            blockExplorerUrls: ['https://vinuexplorer.org']
        };

        function initializeWallet() {
            if (!ethersLoaded || typeof ethers === 'undefined') {
                statusEl.textContent = 'Error: ethers.js not loaded. Please refresh the page.';
                console.error('ethers.js not loaded');
                return;
            }

            provider = new ethers.providers.Web3Provider(window.ethereum);

            async function connectWallet(manual = false) {
                console.log(manual ? 'Manual connect initiated' : 'Auto-detecting wallet...');
                try {
                    if (!window.ethereum || !window.ethereum.isMetaMask) {
                        throw new Error('MetaMask not detected. Install MetaMask from metamask.io.');
                    }
                    spinnerEl.style.display = 'block';
                    statusEl.textContent = manual ? 'Requesting connection...' : 'Auto-detecting wallet...';

                    let accounts;
                    if (manual) {
                        console.log('Requesting accounts manually...');
                        accounts = await provider.send('eth_requestAccounts', []);
                    } else {
                        console.log('Checking existing accounts...');
                        accounts = await provider.send('eth_accounts', []);
                    }

                    if (accounts.length === 0 && !manual) {
                        console.log('No accounts found, keeping connect button visible');
                        statusEl.textContent = 'Please connect your wallet';
                        return;
                    }

                    console.log('Accounts:', accounts);
                    signer = provider.getSigner();
                    userAddress = await signer.getAddress();
                    walletAddressEl.innerHTML = `Connected: <strong>${accounts[0].slice(0, 6)}...${accounts[0].slice(-4)}</strong>`;
                    connectBtn.style.display = 'none';
                    disconnectBtn.style.display = 'inline-block';

                    console.log('Checking network...');
                    const network = await provider.getNetwork();
                    console.log('Current chain ID:', network.chainId);
                    if (network.chainId !== 207) {
                        statusEl.textContent = 'Switching to VinuChain...';
                        console.log('Attempting to switch to VinuChain...');
                        try {
                            await window.ethereum.request({
                                method: 'wallet_switchEthereumChain',
                                params: [{ chainId: '0xCF' }]
                            });
                        } catch (switchError) {
                            if (switchError.code === 4902) {
                                console.log('VinuChain not found, adding...');
                                await window.ethereum.request({
                                    method: 'wallet_addEthereumChain',
                                    params: [{
                                        chainId: vinuChain.chainId,
                                        chainName: vinuChain.chainName,
                                        rpcUrls: vinuChain.rpcUrls,
                                        nativeCurrency: vinuChain.nativeCurrency,
                                        blockExplorerUrls: vinuChain.blockExplorerUrls
                                    }]
                                });
                            } else {
                                throw switchError;
                            }
                        }
                    }

                    // Initialize contracts
                    contract = new ethers.Contract(contractAddress, contractABI, signer);
                    tokenContract = new ethers.Contract(vinTokenAddress, tokenABI, signer);
                    approveBtn.disabled = false;
                    statusEl.textContent = 'Wallet connected successfully!';
                    console.log('Connection successful');
                    updateDashboard();
                    updateLeaderboard();
                } catch (error) {
                    console.error('Connect error:', error);
                    let userMessage = 'Connection failed: ';
                    if (error.code === 4001 || error.message.includes('User rejected')) {
                        userMessage += 'You rejected the request in MetaMask.';
                    } else if (error.message.includes('MetaMask not detected')) {
                        userMessage += 'Install MetaMask from metamask.io.';
                    } else if (error.message.includes('network')) {
                        userMessage += 'Network issue. Add VinuChain manually: Chain ID 207, RPC https://rpc.vinuchain.org.';
                    } else {
                        userMessage += error.message;
                    }
                    statusEl.textContent = userMessage;
                    connectBtn.style.display = 'block';
                    disconnectBtn.style.display = 'none';
                } finally {
                    spinnerEl.style.display = 'none';
                }
            }

            connectBtn.addEventListener('click', () => connectWallet(true));

            disconnectBtn.addEventListener('click', () => {
                signer = null;
                userAddress = null;
                walletAddressEl.innerHTML = '';
                connectBtn.style.display = 'block';
                disconnectBtn.style.display = 'none';
                statusEl.textContent = 'Wallet disconnected';
                console.log('Wallet disconnected');
                approveBtn.disabled = true;
                stakeBtn.disabled = true;
                unstakeBtn.disabled = true;
                emergencyUnstakeBtn.disabled = true;
            });

            // Auto-detect on load
            window.addEventListener('load', () => {
                connectWallet(false);
            });

            // Handle account/network changes
            window.ethereum?.on('accountsChanged', async (accounts) => {
                console.log('Accounts changed:', accounts);
                if (accounts.length === 0) {
                    walletAddressEl.innerHTML = '';
                    statusEl.textContent = 'Please connect MetaMask';
                    connectBtn.style.display = 'block';
                    disconnectBtn.style.display = 'none';
                    approveBtn.disabled = true;
                    stakeBtn.disabled = true;
                    unstakeBtn.disabled = true;
                    emergencyUnstakeBtn.disabled = true;
                } else {
                    await connectWallet(false);
                }
            });

            window.ethereum?.on('chainChanged', async (chainId) => {
                console.log('Chain changed:', chainId);
                if (parseInt(chainId, 16) !== 207) {
                    walletAddressEl.innerHTML = '';
                    statusEl.textContent = 'Please switch to VinuChain';
                    connectBtn.style.display = 'block';
                    disconnectBtn.style.display = 'none';
                    approveBtn.disabled = true;
                    stakeBtn.disabled = true;
                    unstakeBtn.disabled = true;
                    emergencyUnstakeBtn.disabled = true;
                } else {
                    await connectWallet(false);
                }
            });
        }

        // Show/hide spinner
        function showLoader(button) {
            const spinner = button.querySelector('.spinner');
            spinner.style.display = 'inline-block';
            button.disabled = true;
        }

        function hideLoader(button) {
            const spinner = button.querySelector('.spinner');
            spinner.style.display = 'none';
            button.disabled = false;
        }

        // Update dashboard
        async function updateDashboard() {
            if (!contract || !userAddress) return;
            try {
                const [amount, lockTimeLeft, rewards] = await contract.getStakeInfo(userAddress);
                stakedAmountEl.textContent = `${ethers.utils.formatUnits(amount, 18)} VIN`;
                lockTimeEl.textContent = `${Math.ceil(lockTimeLeft / 86400)} Days`;
                rewardsEl.textContent = `${ethers.utils.formatUnits(rewards, 18)} VIN`;
                unstakeBtn.disabled = amount == 0 || lockTimeLeft > 0;
                emergencyUnstakeBtn.disabled = amount == 0;
            } catch (error) {
                dashboardErrorEl.textContent = `Error: ${error.message}`;
                console.error('Dashboard error:', error);
            }
        }

        // Update leaderboard
        async function updateLeaderboard() {
            if (!contract) return;
            try {
                const [users, amounts] = await contract.getLeaderboard();
                leaderboardContent.innerHTML = '';
                if (users.length === 0) {
                    leaderboardContent.innerHTML = '<p>No stakers yet.</p>';
                    return;
                }
                for (let i = 0; i < users.length; i++) {
                    const card = document.createElement('div');
                    card.className = 'card';
                    card.innerHTML = `
                        <h3>Rank ${i + 1}</h3>
                        <p>${users[i].slice(0, 6)}...${users[i].slice(-4)}</p>
                        <p>${ethers.utils.formatUnits(amounts[i], 18)} VIN</p>
                    `;
                    leaderboardContent.appendChild(card);
                }
            } catch (error) {
                leaderboardErrorEl.textContent = `Error: ${error.message}`;
                console.error('Leaderboard error:', error);
            }
        }

        // Approve VIN tokens
        async function approveTokens() {
            const amount = stakeAmountInput.value;
            if (!amount || amount < 10) {
                stakeErrorEl.textContent = 'Enter at least 10 VIN';
                return;
            }
            try {
                showLoader(approveBtn);
                const tx = await tokenContract.approve(contractAddress, ethers.utils.parseUnits(amount, 18));
                await tx.wait();
                stakeErrorEl.textContent = 'Approved! Now stake.';
                stakeBtn.disabled = false;
            } catch (error) {
                stakeErrorEl.textContent = `Error: ${error.message}`;
                console.error('Approve error:', error);
            } finally {
                hideLoader(approveBtn);
            }
        }

        // Stake VIN
        async function stake() {
            const amount = stakeAmountInput.value;
            try {
                showLoader(stakeBtn);
                const tx = await contract.stake(ethers.utils.parseUnits(amount, 18));
                await tx.wait();
                stakeErrorEl.textContent = 'Staked successfully!';
                stakeAmountInput.value = '';
                approveBtn.disabled = false;
                updateDashboard();
                updateLeaderboard();
            } catch (error) {
                stakeErrorEl.textContent = `Error: ${error.message}`;
                console.error('Stake error:', error);
            } finally {
                hideLoader(stakeBtn);
            }
        }

        // Unstake
        async function unstake() {
            try {
                showLoader(unstakeBtn);
                const tx = await contract.unstake();
                await tx.wait();
                dashboardErrorEl.textContent = 'Unstaked successfully!';
                updateDashboard();
                updateLeaderboard();
            } catch (error) {
                dashboardErrorEl.textContent = `Error: ${error.message}`;
                console.error('Unstake error:', error);
            } finally {
                hideLoader(unstakeBtn);
            }
        }

        // Emergency Unstake
        async function emergencyUnstake() {
            try {
                showLoader(emergencyUnstakeBtn);
                const tx = await contract.emergencyUnstake();
                await tx.wait();
                dashboardErrorEl.textContent = 'Emergency unstaked (10% fee applied)!';
                updateDashboard();
                updateLeaderboard();
            } catch (error) {
                dashboardErrorEl.textContent = `Error: ${error.message}`;
                console.error('Emergency unstake error:', error);
            } finally {
                hideLoader(emergencyUnstakeBtn);
            }
        }

        // Event listeners
        approveBtn.addEventListener('click', approveTokens);
        stakeBtn.addEventListener('click', stake);
        unstakeBtn.addEventListener('click', unstake);
        emergencyUnstakeBtn.addEventListener('click', emergencyUnstake);

        // Periodic updates
        setInterval(() => {
            updateDashboard();
            updateLeaderboard();
        }, 30000);

        // Start loading ethers.js
        tryLoadEthers();
    </script>
</body>
</html>
